<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMATA HALONG WORKFLOW</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 for nice popups -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; }
        .sidebar-link.active { background-color: #1e3a8a; border-left: 4px solid #60a5fa; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        
        /* Table Styles */
        .amt-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; padding: 0.75rem 1rem; }
        .amt-table td { padding: 1rem; border-bottom: 1px solid #e2e8f0; font-size: 0.875rem; color: #334155; }
        .amt-table tr:hover { background-color: #f1f5f9; }
        
        /* Monday.com Style Board */
        .monday-cell { transition: all 0.2s; border-right: 1px solid #f1f5f9; }
        .monday-status { cursor: pointer; color: white; font-weight: 500; text-align: center; height: 100%; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; }
        .monday-status:hover { opacity: 0.9; }
        .monday-row { border-bottom: 1px solid #e2e8f0; background: white; transition: background 0.1s; }
        .monday-row:hover { background-color: #f8fafc; }
        .timeline-bar { height: 6px; border-radius: 3px; background: #e2e8f0; overflow: hidden; position: relative; }
        .timeline-progress { height: 100%; background: #3b82f6; }

        /* Custom Scrollbar for modal */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* Tab Styles for Reports */
        .tab-btn { padding: 8px 16px; font-weight: bold; border-bottom: 2px solid transparent; color: #64748b; }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
    </style>
<link rel="stylesheet" href="/index.css">
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <!-- Loading Spinner -->
    <div id="loader" class="loading-overlay hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-600"></div>
    </div>

    <!-- App Container -->
    <div id="app" class="flex w-full h-full">
        <!-- Rendered by JS -->
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        const CONFIG = {
            BIN_ID: '69399c5bae596e708f908443', 
            API_KEY: '$2a$10$SXHVbYBI5MNWEGuKO/hhoeg47HeYzilZB29gM4yofDMP0nbXqER1q' 
        };

        const CONSTANTS = {
            STATUS: {
                TODO: { label: 'Mới tạo', color: 'bg-gray-400', text: 'Chưa bắt đầu' },
                IN_PROGRESS: { label: 'Đang thực hiện', color: 'bg-blue-500', text: 'Đang làm' },
                COMPLETED: { label: 'Hoàn thành', color: 'bg-green-500', text: 'Đã xong' },
                OVERDUE: { label: 'Quá hạn', color: 'bg-red-500', text: 'Quá hạn' },
                STUCK: { label: 'Vướng mắc', color: 'bg-orange-400', text: 'Đang vướng' }
            },
            PERSONAL_STATUS: {
                UNPROCESSED: { label: 'Chưa xử lý', color: 'bg-gray-200 text-gray-700', icon: 'circle' },
                PROCESSING: { label: 'Đang xử lý', color: 'bg-blue-100 text-blue-700', icon: 'loader' },
                COMPLETED: { label: 'Đã hoàn thành', color: 'bg-green-100 text-green-700', icon: 'check-circle' }
            }
        };

        // ==========================================
        // 2. STATE & DATABASE SERVICE
        // ==========================================

        let STATE = {
            currentUser: null,
            users: [],
            tasks: [],
            projects: [],
            personalTasks: [], // New Personal Tasks
            activePage: 'dashboard',
            activeProjectTab: null,
            refreshTimer: null,
            taskFilters: { search: '', project: '', user: '' },
            personalFilterMonth: new Date().toISOString().slice(0, 7) // YYYY-MM
        };

        const DB = {
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': CONFIG.API_KEY
            },
            async fetch(silent = false) {
                if(!silent) toggleLoader(true);
                try {
                    const res = await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}/latest`, {
                        method: 'GET',
                        headers: DB.headers
                    });
                    if (!res.ok) throw new Error("Không thể kết nối Database!");
                    const json = await res.json();
                    STATE.users = json.record.users || [];
                    STATE.tasks = json.record.tasks || [];
                    STATE.projects = json.record.projects || [];
                    STATE.personalTasks = json.record.personalTasks || [];
                    
                    if (!STATE.users.some(u => u.role === 'ADMIN')) {
                         STATE.users.push({id: "u1", empCode: "AMT00001", name: "Admin System", username: "admin", password: "123", role: "ADMIN", isFirst: false});
                         await DB.save();
                    }
                } catch (e) {
                    if(!silent) Swal.fire('Lỗi kết nối', 'Vui lòng kiểm tra Database', 'error');
                } finally {
                    if(!silent) toggleLoader(false);
                }
            },
            async save() {
                toggleLoader(true);
                const payload = { 
                    users: STATE.users, 
                    tasks: STATE.tasks, 
                    projects: STATE.projects,
                    personalTasks: STATE.personalTasks 
                };
                try {
                    await fetch(`https://api.jsonbin.io/v3/b/${CONFIG.BIN_ID}`, {
                        method: 'PUT',
                        headers: DB.headers,
                        body: JSON.stringify(payload)
                    });
                } catch (e) {
                    Swal.fire('Lỗi lưu trữ', 'Không thể lưu dữ liệu', 'error');
                } finally {
                    toggleLoader(false);
                }
            }
        };

        // ==========================================
        // 3. UTILITIES
        // ==========================================
        const $ = (s) => document.querySelector(s);
        const toggleLoader = (show) => $('#loader').classList.toggle('hidden', !show);
        const uuid = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const generateEmpCode = () => {
            if (STATE.users.length === 0) return 'AMT00001';
            const maxId = STATE.users.reduce((max, u) => {
                const num = parseInt(u.empCode.replace('AMT', ''));
                return num > max ? num : max;
            }, 0);
            return 'AMT' + String(maxId + 1).padStart(5, '0');
        };

        const getTaskStatus = (task) => {
            if (task.status === 'COMPLETED') return 'COMPLETED';
            if (task.status === 'STUCK') return 'STUCK';
            const today = new Date().setHours(0,0,0,0);
            const deadline = new Date(task.deadline).setHours(0,0,0,0);
            if (deadline < today) return 'OVERDUE';
            return task.status;
        };

        const isDueSoon = (task) => {
            if (task.status === 'COMPLETED') return false;
            const dead = new Date(task.deadline);
            const now = new Date();
            const diff = (dead - now) / (1000 * 60 * 60 * 24);
            return diff >= 0 && diff <= 3;
        };

        const getAssignees = (task) => Array.isArray(task.assignedTo) ? task.assignedTo : [task.assignedTo];

        // ==========================================
        // 4. CORE UI RENDERERS
        // ==========================================

        const renderLogin = () => {
            $('#app').innerHTML = `
                <div class="w-full flex items-center justify-center bg-slate-900">
                    <div class="bg-white p-8 rounded-lg shadow-2xl w-96 animate-fade-in">
                        <div class="text-center mb-6">
                            <h1 class="text-2xl font-bold text-blue-800">AMATA HALONG</h1>
                            <p class="text-sm text-gray-500 tracking-widest font-semibold mt-1">WORKFLOW SYSTEM</p>
                        </div>
                        <form id="loginForm" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Tên đăng nhập</label>
                                <input type="text" id="username" class="w-full border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Username">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1 uppercase">Mật khẩu</label>
                                <input type="password" id="password" class="w-full border border-gray-300 p-2.5 rounded focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="Password">
                            </div>
                            <button type="submit" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-2.5 rounded transition">ĐĂNG NHẬP</button>
                        </form>
                    </div>
                </div>
            `;
            $('#loginForm').onsubmit = async (e) => {
                e.preventDefault();
                await DB.fetch();
                const u = $('#username').value;
                const p = $('#password').value;
                const user = STATE.users.find(x => x.username === u && x.password === p);
                if (!user) {
                    Swal.fire('Lỗi', 'Sai tên đăng nhập hoặc mật khẩu', 'error');
                } else {
                    if (user.isFirst) forceChangePassword(user);
                    else {
                        STATE.currentUser = user;
                        sessionStorage.setItem('session_user_id', user.id);
                        renderApp();
                    }
                }
            };
        };

        const forceChangePassword = (user) => {
            Swal.fire({
                title: 'Đổi mật khẩu lần đầu',
                input: 'password',
                inputPlaceholder: 'Nhập mật khẩu mới',
                allowOutsideClick: false,
                confirmButtonText: 'Cập nhật',
                preConfirm: (pass) => (!pass || pass.length < 4) ? Swal.showValidationMessage('Mật khẩu quá ngắn') : pass
            }).then(async (result) => {
                if (result.isConfirmed) {
                    user.password = result.value;
                    user.isFirst = false;
                    await DB.save();
                    Swal.fire('Thành công', 'Vui lòng đăng nhập lại', 'success').then(renderLogin);
                }
            });
        };

        const renderApp = () => {
            const user = STATE.currentUser;
            const isAdmin = user.role === 'ADMIN';

            if (STATE.refreshTimer) clearInterval(STATE.refreshTimer);
            STATE.refreshTimer = setInterval(async () => {
                if (!Swal.isVisible()) {
                    await DB.fetch(true);
                    renderContent(STATE.activePage);
                }
            }, 10000);

            $('#app').innerHTML = `
                <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20" id="sidebar">
                    <div class="h-16 flex items-center justify-center border-b border-slate-700 bg-slate-800">
                        <span class="font-bold text-lg tracking-wider text-blue-400">AMATA WORKFLOW</span>
                    </div>
                    <div class="p-4 border-b border-slate-700 flex items-center gap-3 bg-slate-800/50">
                        <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-lg">${user.name.charAt(0)}</div>
                        <div class="overflow-hidden">
                            <div class="font-bold truncate text-sm">${user.name}</div>
                            <div class="text-xs text-slate-400">${user.empCode}</div>
                        </div>
                    </div>
                    <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                        ${navItem('dashboard', 'layout-dashboard', 'Tổng quan (Dashboard)')}
                        ${navItem('personal', 'check-square', 'Công việc cá nhân')}
                        ${navItem('projects', 'trello', 'Quản lý Dự án')}
                        ${navItem('tasks', 'clipboard-list', 'Quản lý Giao việc')}
                        ${navItem('reports', 'bar-chart-2', 'Báo cáo Thống kê')}
                        ${isAdmin ? navItem('users', 'users', 'Quản lý Nhân sự') : ''}
                        ${navItem('settings', 'settings', 'Cài đặt Hệ thống')}
                    </nav>
                    <div class="p-4 bg-slate-900 border-t border-slate-700">
                        <button onclick="logout()" class="w-full flex items-center justify-center gap-2 text-slate-400 hover:text-white hover:bg-red-600/20 py-2 rounded transition">
                            <i data-lucide="log-out" width="18"></i> Đăng xuất
                        </button>
                    </div>
                </aside>
                <main class="flex-1 flex flex-col overflow-hidden bg-slate-100">
                    <header class="h-16 bg-white shadow-sm flex items-center justify-between px-6 z-10">
                        <div class="flex items-center gap-4">
                            <h2 class="text-xl font-bold text-slate-700" id="pageTitle">Tổng quan</h2>
                            <button onclick="manualRefresh()" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full transition"><i data-lucide="refresh-cw" width="18"></i></button>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold px-3 py-1 bg-blue-100 text-blue-700 rounded-full">${user.unit || 'AMATA'}</span>
                        </div>
                    </header>
                    <div class="flex-1 overflow-auto p-6" id="content"></div>
                </main>
            `;
            lucide.createIcons();
            navigate(STATE.activePage);
        };

        const navItem = (id, icon, label) => `
            <button onclick="navigate('${id}')" id="nav-${id}" class="sidebar-link w-full flex items-center gap-3 px-6 py-3 text-slate-300 hover:bg-slate-800 hover:text-white transition-all text-sm font-medium">
                <i data-lucide="${icon}" width="18"></i> ${label}
            </button>
        `;

        const navigate = (pageId) => {
            STATE.activePage = pageId;
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            const activeBtn = document.getElementById(`nav-${pageId}`);
            if(activeBtn) activeBtn.classList.add('active');
            const titles = { dashboard: 'Dashboard Tổng quan', personal: 'Công việc cá nhân (To-do List)', tasks: 'Quản lý Công việc', projects: 'Dự án (Project Board)', reports: 'Báo cáo & Xuất dữ liệu', users: 'Quản trị Nhân sự', settings: 'Thiết lập Tài khoản' };
            $('#pageTitle').innerText = titles[pageId];
            renderContent(pageId);
        };

        const renderContent = (pageId) => {
            const container = $('#content');
            container.innerHTML = '';
            switch(pageId) {
                case 'dashboard': renderDashboard(container); break;
                case 'personal': renderPersonalTasks(container); break;
                case 'tasks': renderTasks(container); break;
                case 'projects': renderProjectBoard(container); break;
                case 'reports': renderReports(container); break;
                case 'users': renderUsers(container); break;
                case 'settings': renderSettings(container); break;
            }
            lucide.createIcons();
        };

        // ==========================================
        // 5. FEATURE MODULES
        // ==========================================

        /* --- DASHBOARD --- */
        const renderDashboard = (el) => {
            const tasks = STATE.tasks;
            const stats = {
                total: tasks.length,
                completed: tasks.filter(t => t.status === 'COMPLETED').length,
                processing: tasks.filter(t => t.status === 'IN_PROGRESS' || t.status === 'TODO').length,
                overdue: tasks.filter(t => getTaskStatus(t) === 'OVERDUE').length,
                dueSoon: tasks.filter(t => isDueSoon(t)).length
            };

            // Personal Summary for this month
            const currentMonth = new Date().toISOString().slice(0, 7);
            const myPersonal = STATE.personalTasks.filter(t => t.userId === STATE.currentUser.id && t.deadline.startsWith(currentMonth));
            const pStats = {
                total: myPersonal.length,
                completed: myPersonal.filter(t => t.status === 'COMPLETED').length,
                processing: myPersonal.filter(t => t.status === 'PROCESSING').length,
                unprocessed: myPersonal.filter(t => t.status === 'UNPROCESSED').length
            };

            el.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
                    ${statCard('Tổng công việc', stats.total, 'briefcase', 'text-gray-600', 'bg-white')}
                    ${statCard('Đã hoàn thành', stats.completed, 'check-circle', 'text-green-600', 'bg-green-50')}
                    ${statCard('Đang thực hiện', stats.processing, 'clock', 'text-blue-600', 'bg-blue-50')}
                    ${statCard('Sắp hết hạn', stats.dueSoon, 'alert-triangle', 'text-yellow-600', 'bg-yellow-50')}
                    ${statCard('Đã quá hạn', stats.overdue, 'alert-octagon', 'text-red-600', 'bg-red-50')}
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Personal Tasks Section -->
                    <div class="lg:col-span-1 bg-white rounded-lg shadow p-6 border-t-4 border-indigo-600">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-bold text-gray-700">Công việc cá nhân (T${new Date().getMonth()+1})</h3>
                            <button onclick="navigate('personal')" class="text-xs text-blue-600 font-bold hover:underline">Chi tiết</button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">Tổng việc cần làm:</span>
                                <span class="font-bold text-gray-800">${pStats.total}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">Đã hoàn thành:</span>
                                <span class="font-bold text-green-600">${pStats.completed}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-500">Đang xử lý:</span>
                                <span class="font-bold text-blue-600">${pStats.processing}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${pStats.total ? (pStats.completed/pStats.total)*100 : 0}%"></div>
                            </div>
                            <p class="text-[10px] text-gray-400 text-center italic mt-1">Tiến độ cá nhân trong tháng: ${pStats.total ? Math.round((pStats.completed/pStats.total)*100) : 0}%</p>
                        </div>
                    </div>

                    <!-- Staff Stats Table -->
                    <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
                        <h3 class="font-bold text-gray-700 mb-4 border-l-4 border-blue-600 pl-3">Tiến độ nhân sự (Công việc chung)</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full amt-table text-left">
                                <thead><tr><th>Nhân viên</th><th class="text-center">Tổng việc</th><th class="text-center">Hoàn thành</th><th class="text-center">Quá hạn</th></tr></thead>
                                <tbody>
                                    ${STATE.users.filter(u => u.role === 'STAFF').map(u => {
                                        const myTasks = tasks.filter(t => getAssignees(t).includes(u.id));
                                        const done = myTasks.filter(t => t.status === 'COMPLETED').length;
                                        return `<tr><td>${u.name}</td><td class="text-center">${myTasks.length}</td><td class="text-center text-green-600 font-bold">${done}</td><td class="text-center text-red-600 font-bold">${myTasks.filter(t => getTaskStatus(t) === 'OVERDUE').length}</td></tr>`;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        };

        /* --- PERSONAL TASKS (NEW) --- */
        const renderPersonalTasks = (el) => {
            const userId = STATE.currentUser.id;
            const filterMonth = STATE.personalFilterMonth;
            
            let myTasks = STATE.personalTasks.filter(t => t.userId === userId);
            if (filterMonth) {
                myTasks = myTasks.filter(t => t.deadline.startsWith(filterMonth));
            }

            el.innerHTML = `
                <div class="bg-white p-4 rounded-lg shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="flex flex-col">
                            <label class="text-[10px] font-bold text-gray-500 uppercase">Lọc theo tháng</label>
                            <input type="month" value="${filterMonth}" onchange="STATE.personalFilterMonth = this.value; renderPersonalTasks($('#content'))" class="border p-2 rounded text-sm outline-none focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <div class="text-sm font-medium text-gray-600 pt-4">
                            (Tìm thấy ${myTasks.length} công việc)
                        </div>
                    </div>
                    <button onclick="openPersonalTaskModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded text-sm font-bold flex items-center gap-2 shadow-sm transition">
                        <i data-lucide="plus-circle"></i> Thêm việc cá nhân
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
                    <table class="w-full amt-table text-left">
                        <thead>
                            <tr>
                                <th class="w-[30%]">Tên công việc</th>
                                <th class="w-[15%] text-center">Thời hạn (Deadline)</th>
                                <th class="w-[15%] text-center">Trạng thái</th>
                                <th class="w-[30%]">Ghi chú</th>
                                <th class="w-[10%] text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${myTasks.length > 0 ? myTasks.map(t => {
                                const st = CONSTANTS.PERSONAL_STATUS[t.status];
                                return `
                                    <tr class="group">
                                        <td>
                                            <div class="font-bold text-slate-700">${t.title}</div>
                                            <div class="text-xs text-slate-400 mt-1">${t.description || ''}</div>
                                        </td>
                                        <td class="text-center font-medium">${t.deadline}</td>
                                        <td class="text-center">
                                            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold ${st.color}">
                                                <i data-lucide="${st.icon}" width="12"></i> ${st.label}
                                            </span>
                                        </td>
                                        <td><div class="text-sm text-slate-500 truncate max-w-[200px]" title="${t.notes || ''}">${t.notes || '-'}</div></td>
                                        <td class="text-center">
                                            <div class="flex items-center justify-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button onclick="openPersonalTaskModal('${t.id}')" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-full transition"><i data-lucide="edit-2" width="16"></i></button>
                                                <button onclick="deletePersonalTask('${t.id}')" class="p-1.5 text-red-600 hover:bg-red-50 rounded-full transition"><i data-lucide="trash-2" width="16"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('') : `<tr><td colspan="5" class="text-center py-12 text-gray-400 italic">Chưa có công việc nào cho tháng này</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();
        };

        window.openPersonalTaskModal = (editId = null) => {
            const task = editId ? STATE.personalTasks.find(t => t.id === editId) : null;
            Swal.fire({
                title: editId ? 'Sửa công việc cá nhân' : 'Thêm việc mới',
                width: '500px',
                html: `
                    <div class="text-left space-y-4 pt-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tên công việc <span class="text-red-500">*</span></label>
                            <input id="p-title" class="swal2-input m-0 w-full h-10 text-sm" placeholder="Nhập tên việc..." value="${task?.title || ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nội dung chi tiết</label>
                            <textarea id="p-desc" class="swal2-textarea m-0 w-full text-sm h-20" placeholder="Mô tả công việc...">${task?.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Thời hạn (Deadline) <span class="text-red-500">*</span></label>
                            <input type="date" id="p-deadline" class="swal2-input m-0 w-full h-10 text-sm" value="${task?.deadline || new Date().toISOString().slice(0, 10)}">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Trạng thái</label>
                            <div class="flex gap-2">
                                <label class="flex-1 border p-2 rounded cursor-pointer flex items-center justify-center gap-2 text-xs font-bold transition-all hover:bg-gray-50">
                                    <input type="radio" name="p-status" value="UNPROCESSED" ${task?.status === 'UNPROCESSED' || !task ? 'checked' : ''}> Chưa xử lý
                                </label>
                                <label class="flex-1 border p-2 rounded cursor-pointer flex items-center justify-center gap-2 text-xs font-bold transition-all hover:bg-gray-50">
                                    <input type="radio" name="p-status" value="PROCESSING" ${task?.status === 'PROCESSING' ? 'checked' : ''}> Đang xử lý
                                </label>
                                <label class="flex-1 border p-2 rounded cursor-pointer flex items-center justify-center gap-2 text-xs font-bold transition-all hover:bg-gray-50">
                                    <input type="radio" name="p-status" value="COMPLETED" ${task?.status === 'COMPLETED' ? 'checked' : ''}> Đã xong
                                </label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ghi chú</label>
                            <input id="p-notes" class="swal2-input m-0 w-full h-10 text-sm" placeholder="Nhập ghi chú cá nhân..." value="${task?.notes || ''}">
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Lưu thay đổi',
                preConfirm: () => {
                    const title = $('#p-title').value;
                    const deadline = $('#p-deadline').value;
                    if (!title || !deadline) return Swal.showValidationMessage('Vui lòng nhập Tên và Thời hạn');
                    return {
                        title,
                        description: $('#p-desc').value,
                        deadline,
                        status: document.querySelector('input[name="p-status"]:checked').value,
                        notes: $('#p-notes').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const d = result.value;
                    if (editId) {
                        Object.assign(task, d);
                    } else {
                        STATE.personalTasks.push({ id: uuid(), userId: STATE.currentUser.id, ...d });
                    }
                    await DB.save();
                    renderPersonalTasks($('#content'));
                    Swal.fire('Đã lưu!', '', 'success');
                }
            });
        };

        window.deletePersonalTask = (id) => {
            Swal.fire({ title: 'Xóa việc này?', icon: 'warning', showCancelButton: true }).then(async (r) => {
                if(r.isConfirmed) {
                    STATE.personalTasks = STATE.personalTasks.filter(t => t.id !== id);
                    await DB.save();
                    renderPersonalTasks($('#content'));
                }
            });
        };

        /* --- OTHER MODULES (Unchanged Logic, added for completeness) --- */
        const renderProjectBoard = (el) => {
            if (!STATE.activeProjectTab && STATE.projects.length > 0) STATE.activeProjectTab = STATE.projects[0].id;
            else if (!STATE.activeProjectTab) STATE.activeProjectTab = 'ADHOC';
            const projects = [...STATE.projects, { id: 'ADHOC', name: 'Việc lẻ (Ad-hoc)' }];
            const tasks = STATE.tasks.filter(t => STATE.activeProjectTab === 'ADHOC' ? !t.projectId : t.projectId === STATE.activeProjectTab);
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'COMPLETED').length;
            const percent = total ? Math.round((completed/total)*100) : 0;
            const isAdmin = STATE.currentUser.role === 'ADMIN';

            el.innerHTML = `
                <div class="flex items-center gap-2 overflow-x-auto pb-2 mb-4 custom-scroll">
                    ${projects.map(p => `<button onclick="STATE.activeProjectTab = '${p.id}'; renderProjectBoard($('#content'))" class="whitespace-nowrap px-4 py-2 rounded-full text-sm font-bold transition-all border ${STATE.activeProjectTab === p.id ? 'bg-blue-600 text-white border-blue-600 shadow' : 'bg-white text-gray-500 border-gray-200 hover:bg-gray-50'}">${p.name}</button>`).join('')}
                    ${isAdmin ? `<button onclick="createNewProject()" class="whitespace-nowrap px-3 py-2 rounded-full text-sm font-bold bg-gray-200 text-gray-600 hover:bg-gray-300"><i data-lucide="plus" width="16"></i></button>` : ''}
                </div>
                <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                    <div class="p-4 flex justify-between items-center border-b">
                        <div><h3 class="text-xl font-bold">${projects.find(p=>p.id===STATE.activeProjectTab)?.name}</h3><div class="w-64 h-2 bg-gray-200 rounded-full mt-2"><div class="h-full bg-green-500 rounded-full" style="width: ${percent}%"></div></div></div>
                        ${isAdmin ? `<button onclick="openTaskModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow flex items-center gap-2"><i data-lucide="plus"></i> Thêm việc</button>` : ''}
                    </div>
                    <div class="overflow-x-auto min-h-[400px]">
                        <div class="min-w-[1000px]">
                            <div class="flex bg-slate-50 border-b text-[10px] font-bold text-gray-500 uppercase tracking-widest p-3">
                                <div class="w-[350px]">Nội dung công việc</div><div class="w-[150px] text-center">Người thực hiện</div><div class="w-[150px] text-center">Trạng thái</div><div class="w-[200px] text-center">Hạn chót</div><div class="flex-1">Kết quả cập nhật</div>
                            </div>
                            ${tasks.length > 0 ? tasks.map(t => {
                                const status = getTaskStatus(t);
                                const isUserRelated = isAdmin || getAssignees(t).includes(STATE.currentUser.id);
                                return `<div class="flex monday-row text-sm items-center p-3 border-b">
                                    <div class="w-[350px] font-medium text-gray-700 cursor-pointer" onclick="viewTask('${t.id}')">${t.title}</div>
                                    <div class="w-[150px] flex justify-center">${getAssignees(t).map(id=>`<div class="w-7 h-7 rounded-full bg-blue-600 text-white flex items-center justify-center text-[10px] font-bold border-2 border-white -ml-2 first:ml-0">${STATE.users.find(u=>u.id===id)?.name?.charAt(0)}</div>`).join('')}</div>
                                    <div class="w-[150px]"><div onclick="${isUserRelated?`quickStatus('${t.id}')`:''}" class="${CONSTANTS.STATUS[status].color} text-white text-[10px] font-bold py-1 rounded text-center cursor-pointer">${CONSTANTS.STATUS[status].text}</div></div>
                                    <div class="w-[200px] text-center text-xs ${status==='OVERDUE'?'text-red-600 font-bold':''}">${t.deadline}</div>
                                    <div class="flex-1 text-xs text-gray-400 truncate">${t.reportResult || '+ Cập nhật kết quả'}</div>
                                </div>`;
                            }).join('') : `<div class="py-20 text-center text-gray-400">Không có công việc nào</div>`}
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        };

        const renderTasks = (el) => {
            const isAdmin = STATE.currentUser.role === 'ADMIN';
            const filters = STATE.taskFilters;
            let tasks = STATE.tasks.filter(t => isAdmin || getAssignees(t).includes(STATE.currentUser.id));
            if (filters.search) tasks = tasks.filter(t => t.title.toLowerCase().includes(filters.search.toLowerCase()));
            if (filters.project) tasks = tasks.filter(t => filters.project === 'ADHOC' ? !t.projectId : t.projectId === filters.project);
            if (isAdmin && filters.user) tasks = tasks.filter(t => getAssignees(t).includes(filters.user));

            el.innerHTML = `
                <div class="flex justify-between mb-4 gap-3">
                    <div class="flex gap-2 flex-1">
                        <input type="text" placeholder="Tìm công việc..." class="border p-2 rounded text-sm w-64 outline-none focus:ring-1 focus:ring-blue-500" value="${filters.search}" onkeyup="setTaskFilter('search', this.value)">
                        <select class="border p-2 rounded text-sm w-48 outline-none focus:ring-1 focus:ring-blue-500" onchange="setTaskFilter('project', this.value)">
                            <option value="">-- Tất cả Dự án --</option><option value="ADHOC" ${filters.project==='ADHOC'?'selected':''}>Việc lẻ</option>
                            ${STATE.projects.map(p => `<option value="${p.id}" ${filters.project===p.id?'selected':''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    ${isAdmin ? `<button onclick="openTaskModal()" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold flex items-center gap-2 shadow"><i data-lucide="plus"></i> Giao việc</button>` : ''}
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full amt-table text-left">
                        <thead><tr><th>Tên việc</th><th>Dự án</th><th>Chủ trì</th><th>Hạn chót</th><th>Trạng thái</th><th class="text-center">Thao tác</th></tr></thead>
                        <tbody>
                            ${tasks.length > 0 ? tasks.map(t => {
                                const st = CONSTANTS.STATUS[getTaskStatus(t)];
                                return `<tr><td class="font-bold text-slate-700 cursor-pointer" onclick="viewTask('${t.id}')">${t.title}</td><td>${t.projectId ? STATE.projects.find(p=>p.id===t.projectId)?.name : 'Việc lẻ'}</td><td>${getAssignees(t).map(id=>STATE.users.find(u=>u.id===id)?.name).join(', ')}</td><td class="${st.text==='Quá hạn'?'text-red-600 font-bold':''}">${t.deadline}</td><td><span class="px-2 py-0.5 rounded text-[10px] font-bold ${st.color} text-white">${st.label}</span></td><td class="text-center"><button onclick="viewTask('${t.id}')" class="text-blue-600 p-1"><i data-lucide="eye" width="16"></i></button></td></tr>`;
                            }).join('') : `<tr><td colspan="6" class="text-center py-8">Không có dữ liệu</td></tr>`}
                        </tbody>
                    </table>
                </div>
            `;
            lucide.createIcons();
        };

        const renderReports = (el) => {
            el.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="bg-white p-8 rounded shadow text-center"><i data-lucide="pie-chart" class="mx-auto w-12 h-12 text-blue-600 mb-4"></i><h3 class="font-bold mb-4">Báo cáo Tổng hợp</h3><button onclick="openSummaryReport()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Xem báo cáo</button></div></div>`;
            lucide.createIcons();
        };

        const renderUsers = (el) => {
             el.innerHTML = `<div class="flex justify-end mb-4"><button onclick="openUserModal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Thêm Nhân sự</button></div><div class="bg-white rounded shadow overflow-hidden"><table class="w-full amt-table"><thead><tr><th>Họ tên</th><th>Mã NV</th><th>Username</th><th>Vai trò</th></tr></thead><tbody>${STATE.users.map(u=>`<tr><td class="font-bold">${u.name}</td><td>${u.empCode}</td><td>${u.username}</td><td>${u.role}</td></tr>`).join('')}</tbody></table></div>`;
             lucide.createIcons();
        };

        const renderSettings = (el) => {
            const u = STATE.currentUser;
            el.innerHTML = `<div class="max-w-xl mx-auto bg-white p-8 rounded shadow"><h3 class="text-xl font-bold mb-6 border-b pb-2">Thông tin tài khoản</h3><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Họ tên</label><div class="p-2 border rounded bg-gray-50">${u.name}</div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Đổi mật khẩu</label><input type="password" id="newPass" class="w-full border p-2 rounded" placeholder="Mật khẩu mới..."><button onclick="updatePass()" class="mt-2 bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold">Cập nhật</button></div></div></div>`;
        };

        /* --- ACTIONS --- */
        window.setTaskFilter = (key, val) => { STATE.taskFilters[key] = val; renderTasks($('#content')); };
        window.manualRefresh = async () => { await DB.fetch(); renderContent(STATE.activePage); };
        window.logout = () => { sessionStorage.clear(); renderLogin(); };
        window.updatePass = async () => { const p = $('#newPass').value; if(p.length < 4) return Swal.fire('Lỗi', 'Quá ngắn', 'error'); STATE.currentUser.password = p; await DB.save(); Swal.fire('Xong!', '', 'success'); };

        window.openSummaryReport = () => {
             const staffData = STATE.users.filter(u => u.role === 'STAFF').map(u => {
                const myTasks = STATE.tasks.filter(t => getAssignees(t).includes(u.id));
                const total = myTasks.length;
                const done = myTasks.filter(t => t.status === 'COMPLETED').length;
                const overdue = myTasks.filter(t => getTaskStatus(t) === 'OVERDUE').length;
                return { name: u.name, total, done, rate: total?Math.round((done/total)*100):0, overdue };
            });

            Swal.fire({
                title: 'Báo cáo Tổng hợp Nhân sự',
                width: '800px',
                html: `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left border">
                            <thead class="bg-gray-50"><tr><th class="p-2 border">Họ tên</th><th class="p-2 border text-center">Tổng việc</th><th class="p-2 border text-center">Hoàn thành</th><th class="p-2 border text-center">Tỷ lệ</th><th class="p-2 border text-center">Quá hạn</th></tr></thead>
                            <tbody>${staffData.map(s=>`<tr><td class="p-2 border font-bold">${s.name}</td><td class="p-2 border text-center">${s.total}</td><td class="p-2 border text-center text-green-600 font-bold">${s.done}</td><td class="p-2 border text-center">${s.rate}%</td><td class="p-2 border text-center text-red-600 font-bold">${s.overdue}</td></tr>`).join('')}</tbody>
                        </table>
                    </div>
                `
            });
        };

        // Initialize
        (async () => {
            const sessId = sessionStorage.getItem('session_user_id');
            if(sessId) {
                await DB.fetch();
                const user = STATE.users.find(u => u.id === sessId);
                if(user) { STATE.currentUser = user; renderApp(); }
                else renderLogin();
            } else renderLogin();
        })();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>