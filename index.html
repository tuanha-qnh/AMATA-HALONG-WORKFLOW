
        /* --- TASK MANAGEMENT --- */
        const renderTasks = (el) => {
            const isAdmin = STATE.currentUser.role === 'ADMIN';

            el.innerHTML = `
                <div class="flex flex-col md:flex-row justify-between mb-4 items-center gap-3">
                    <div class="flex flex-1 gap-2 items-center w-full">
                        <div class="relative w-full md:w-64">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                            <input type="text" id="task-search" placeholder="Tìm tên việc, dự án..." class="border pl-9 p-2 rounded text-sm w-full shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        ${isAdmin ? `
                            <select id="task-assignee-filter" class="border p-2 rounded text-sm w-full md:w-56 shadow-sm outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                <option value="ALL">-- Tất cả nhân sự --</option>
                                ${STATE.users.map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                            </select>
                        ` : ''}
                    </div>

                    ${isAdmin ? `<button onclick="openTaskModal()" class="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold flex items-center justify-center gap-2 shadow-sm transition"><i data-lucide="plus"></i> Giao việc mới</button>` : ''}
                </div>

                <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-100">
                    <table class="w-full amt-table text-left" id="taskTable">
                        <thead>
                            <tr>
                                <th>Loại</th>
                                <th>Tiêu đề / Dự án</th>
                                <th>Chủ trì (Nhóm)</th>
                                <th>Phối hợp</th>
                                <th>Ngày giao</th>
                                <th>Hạn chót</th>
                                <th>Trạng thái</th>
                                <th class="text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="task-tbody">
                            <!-- Rows go here -->
                        </tbody>
                    </table>
                     <div id="no-tasks" class="hidden p-8 text-center text-gray-400 bg-gray-50 italic">Không tìm thấy công việc nào phù hợp</div>
                </div>
            `;

            // Filter Logic
            const runFilter = () => {
                const term = $('#task-search').value.toLowerCase();
                const assigneeId = isAdmin ? $('#task-assignee-filter').value : 'ALL';

                // Get initial list based on permissions
                let visibleTasks = STATE.tasks.filter(t => {
                     const assignees = getAssignees(t);
                     const isAssigned = assignees.includes(STATE.currentUser.id);
                     const isCollab = t.collaborators && t.collaborators.includes(STATE.currentUser.id);
                     return isAdmin || isAssigned || isCollab;
                });

                // Apply Filters
                visibleTasks = visibleTasks.filter(t => {
                    // 1. Text Filter (Title or Project Name)
                    const pjName = t.projectId ? (STATE.projects.find(p=>p.id===t.projectId)?.name || '') : '';
                    const matchText = t.title.toLowerCase().includes(term) || pjName.toLowerCase().includes(term);

                    // 2. Assignee Filter (Admin only)
                    let matchAssignee = true;
                    if (isAdmin && assigneeId !== 'ALL') {
                        const assignees = getAssignees(t);
                        // Filter if user is Assignee OR Collaborator
                        matchAssignee = assignees.includes(assigneeId) || (t.collaborators && t.collaborators.includes(assigneeId));
                    }

                    return matchText && matchAssignee;
                });

                // Render Rows
                const tbody = $('#task-tbody');
                const noData = $('#no-tasks');

                if (visibleTasks.length === 0) {
                    tbody.innerHTML = '';
                    noData.classList.remove('hidden');
                } else {
                    noData.classList.add('hidden');
                    tbody.innerHTML = visibleTasks.map(t => {
                         const st = CONSTANTS.STATUS[getTaskStatus(t)];
                         const assignees = getAssignees(t);
                         const assigneeNames = assignees.map(id => STATE.users.find(u => u.id === id)?.name || 'N/A').join(', ');
                         const collabCount = (t.collaborators || []).length;
                         const pj = t.projectId ? STATE.projects.find(p=>p.id===t.projectId)?.name : 'Việc lẻ';

                         return `
                            <tr class="hover:bg-blue-50/50 transition border-b last:border-0 border-gray-100">
                                <td class="py-3 px-4"><span class="text-[10px] uppercase font-bold px-2 py-1 rounded border ${t.projectId ? 'bg-indigo-50 text-indigo-700 border-indigo-100' : 'bg-gray-50 text-gray-600 border-gray-100'}">${t.projectId ? 'Dự án' : 'Lẻ'}</span></td>
                                <td class="py-3 px-4">
                                    <div class="font-bold text-slate-700 hover:text-blue-600 cursor-pointer" onclick="viewTask('${t.id}')">${t.title}</div>
                                    <div class="text-xs text-gray-500 truncate max-w-[200px]">${pj}</div>
                                    ${t.extensionStatus === 'PENDING' ? '<span class="text-[10px] bg-yellow-100 text-yellow-700 px-1 rounded ml-1 animate-pulse">Xin gia hạn</span>' : ''}
                                </td>
                                <td class="py-3 px-4 font-medium text-blue-900 truncate max-w-[150px]" title="${assigneeNames}">${assigneeNames}</td>
                                <td class="py-3 px-4 text-xs text-gray-500 text-center">${collabCount > 0 ? `+${collabCount}` : '-'}</td>
                                <td class="py-3 px-4 text-sm text-gray-600">${t.startDate}</td>
                                <td class="py-3 px-4">
                                    <span class="text-sm ${getTaskStatus(t)==='OVERDUE'?'text-red-600 font-bold':''}">${t.deadline}</span>
                                </td>
                                <td class="py-3 px-4"><span class="text-[11px] font-bold px-2.5 py-1 rounded-full ${st.color}">${st.label}</span></td>
                                <td class="py-3 px-4 text-center">
                                    <div class="flex items-center justify-center gap-1">
                                        <button onclick="viewTask('${t.id}')" class="text-blue-600 hover:bg-blue-100 p-1.5 rounded transition" title="Xem chi tiết"><i data-lucide="eye" width="16"></i></button>
                                        ${isAdmin ? `
                                            <button onclick="editTask('${t.id}')" class="text-amber-600 hover:bg-amber-100 p-1.5 rounded transition" title="Sửa"><i data-lucide="edit-3" width="16"></i></button>
                                            <button onclick="deleteTask('${t.id}')" class="text-red-600 hover:bg-red-100 p-1.5 rounded transition" title="Xóa"><i data-lucide="trash-2" width="16"></i></button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    lucide.createIcons();
                }
            };

            // Bind events
            $('#task-search').onkeyup = runFilter;
            if (isAdmin) $('#task-assignee-filter').onchange = runFilter;

            // Run initially
            runFilter();
        };